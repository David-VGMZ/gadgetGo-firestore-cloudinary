<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gadget Go!</title>
    <link rel="manifest" href="manifest.webmanifest"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="apple-touch-icon" href="./icons/icon-192.png" />
    <link rel="icon" href="./icons/icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* Estilos para el boton Instalar App */
        .thumb { height: 70px; object-fit: cover; border-radius: .35rem;}
        .thumbs-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: .5rem;}
        #btnInstall {
        position: fixed; right: 16px; bottom: 16px;
        padding: 12px 16px; border: 0; border-radius: 10px;
        background: #122C4F; color: white; font-size: 14px; cursor: pointer;
        box-shadow: 0 6px 18px rgba(0,0,0,.2); z-index: 9999;
        }

        :root {
            --primary-blue: #122C4F;
            --cream-bg: #ffffff;
            --dark-text: #ffffff;
        }

        .py-5 {
            padding-top: 3rem !important;
            padding-bottom: 0rem !important;
        }

        .btn-link {
            color: #122C4F;
        }

        .navbar {
            background-color: #122C4F;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);

        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark-text) !important;
        }

        .nav-link {
            color: var(--dark-text) !important;
            margin: 0 1rem;
            font-weight: 500;
        }

        .hero-section {
            text-align: center;
            padding: 3rem 0;
        }

        .btn-primary {
            background-color: var(--primary-blue);
            border: none;
            color: white;
            padding: .5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-danger {
            border: 2px solid #891521;
            background-color: #891521;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            margin-left: 1rem;
            transition: all 0.3s ease;
        }

        .btn-primary-custom {
            background-color: var(--primary-blue);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-custom:hover {
            background-color: #122C4F;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(74, 144, 226, 0.3);
        }

        .btn-outline-danger-custom {
            border: 2px solid #DC3545;
            color: #DC3545;
            background-color: transparent;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            margin-left: 1rem;
            transition: all 0.3s ease;
        }

        .btn-outline-danger-custom:hover {
            background-color: #DC3545;
            color: white;
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-box {
            width: 120px;
            height: 120px;
            border: 3px solid var(--primary-blue);
            border-radius: 12px;
            margin: 0 auto 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-card .card-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 1rem;
            font-weight: 600;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            background-color: var(--primary-blue);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #CED4DA;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
        }
        .nav-link .bi-cart {
        font-size: 1.8rem;
        color: white;
        }

        .nav-link .bi-cart:hover {
        color: #ffc107;
        }

    </style>
</head>
<body>
    <!--Navbar-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background-color: #122C4F;">
        <div class="container-fluid">

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a href="index.html">
                <img class="thumbs mx-4" src="./icons/icon-512.png" alt="LogoGadget-Go" width="100">
            </a>
                <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#carritoModal" style="font-size: 1.4rem;">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span id="contador-carrito" class="position-absolute top-0 start-100 translate-middle badge rounded-pill" style="background-color: #FBF9E4; color: #122C4F;">
                        0
                    </span>
                </a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#productos" style="font-size: 1.2rem;">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="#modal" data-bs-toggle="modal" data-bs-target="#myModal" style="font-size: 1.2rem;">Contacto</a></li>
                    <li class="nav-item"><a class="nav-link" href="inventario2.html" style="font-size: 1.2rem;">Inventario</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <header id="inicio" class="mt-5 py-4" style="background-color: #ffffff;">
        <div class="toast-container position-fixed top-0 end-0 p-3" id="toastZone"></div>
    </header>

    <div class="pt-4 pb-3 mt-4">
            <a class="ms-3" href="index.html">
                <button class="btn btn-primary">Volver</button>
            </a>
        </div>
    
<script>
  // Recuperar carrito o inicializarlo vacío
  let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

  function guardarCarrito() {
    localStorage.setItem('carrito', JSON.stringify(carrito));
    }

  function agregarAlCarrito(producto) {
    const item = carrito.find(p => p.id === producto.id);
    if (item) {
      item.cantidad++;
    } else {
      carrito.push(producto);
    }
    guardarCarrito();
    actualizarCarrito();

    showToast('<i class="fa-solid fa-cart-plus me-2"></i> Producto agregado al carrito', "primary");

    }

  function eliminarDelCarrito(id) {
    carrito = carrito.filter(p => String(p.id) !== String(id));
    guardarCarrito();
    actualizarCarrito();
    const alert = document.createElement('div');
    showToast('<i class="fa-solid fa-cart-plus me-2"></i> Producto eliminado del carrito', "danger");
    alert.className = "alert alert-danger position-fixed top-0 end-0 m-3";
    alert.textContent = "Producto eliminado del carrito";
    document.body.appendChild(alert);
    }


  function vaciarCarrito() {
    carrito = [];
    guardarCarrito();
    actualizarCarrito();
  }

 // Actualizar vista del carrito en el modal y contador
  function actualizarCarrito() {
    const contenedor = document.getElementById('carrito-container');
    const contador = document.getElementById('contador-carrito');
    contador.textContent = carrito.reduce((acc, p) => acc + p.cantidad, 0);

    // Escuchar cuando se abre el modal del carrito
    const carritoModal = document.getElementById('carritoModal');
    if (carritoModal) {
        carritoModal.addEventListener('shown.bs.modal', function () {

                actualizarCarrito();
        });
    }

    if (carrito.length === 0) {
      contenedor.innerHTML = '<p class="text-center text-muted">Tu carrito está vacío</p>';
      return;
    }

    contenedor.innerHTML = carrito.map(p => `
      <div class="producto border rounded p-2 my-2 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <img src="${p.imagen}" width="80" class="me-3 rounded">
          <div> 
            <h5 class="mb-1">${p.nombre}</h5>
            <p class="mb-0">$${p.precio} x ${p.cantidad}</p>
          </div>
        </div>
        <button class="btn btn-danger btn-sm" onclick="eliminarDelCarrito('${p.id}')">X</button>
      </div>
    `).join('');
  }

  // Mostrar carrito al cargar la página
  document.addEventListener('DOMContentLoaded', actualizarCarrito);

  function showToast(msg, type = "success") {
        const container = document.getElementById("toastZone");

        const toastEl = document.createElement("div");
        toastEl.className = `toast align-items-center text-bg-${type} border-0`;
        toastEl.setAttribute("role", "alert");
        toastEl.setAttribute("aria-live", "assertive");
        toastEl.setAttribute("aria-atomic", "true");

        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${msg}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;

        container.appendChild(toastEl);

        const toast = new bootstrap.Toast(toastEl);
        toast.show();

        // remover después de 4 segundos
        setTimeout(() => toastEl.remove(), 4000);
    }
</script>

    <section id="productos" class="container my-3">
        <div class="container" id="producto-container">
            <p class="text-center text-muted">Cargando producto...</p>
        </div>
    </section>

    <!-- The Modal -->
    <div class="modal fade" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Contacto</h4>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombre" placeholder="Tu nombre">
                        </div>
                        <div class="mb-3">
                            <label for="correo" class="form-label">Correo</label>
                            <input type="email" class="form-control" id="correo" placeholder="Tu correo electronico">
                        </div>
                        <div class="mb-3">
                            <label for="mensaje" class="form-label">Mensaje</label>
                            <textarea class="form-control" id="mensaje" rows="3" placeholder="Tu mensaje"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" data-bs-toggle="tooltip" title="Enviar Formulario">Enviar</button>
                    </form>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal del Carrito -->
    <div class="modal fade" id="carritoModal" tabindex="-1" aria-labelledby="carritoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #122C4F; color: white;">
                    <h5 class="modal-title" id="carritoLabel">
                        <i class="fas fa-shopping-cart me-2"></i>Tu Carrito
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            
                <div class="modal-body" id="carrito-container">
                    <p class="text-center text-muted">Cargando carrito...</p>
                </div>

                <!-- Total del carrito -->
                <div class="px-4 py-2 bg-light border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Total:</h5>
                        <h2 class="mb-0 text-success" id="total-carrito">$0.00</h2>
                    </div>
                </div>
            
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="vaciarCarrito()">
                        <i class="fas fa-trash me-2"></i>Vaciar Carrito
                    </button>
                    <a href="carrito.html">
                        <button type="button" class="btn btn-secondary">
                            Ir al Carrito
                        </button>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Checkout -->
    <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #122C4F; color: white;">
                    <h5 class="modal-title" id="checkoutLabel">
                        <i class="fas fa-shipping-fast me-2"></i>Datos de Envío
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            
                <div class="modal-body">
                    <form id="checkoutForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nombreEnvio" class="form-label">Nombre completo *</label>
                                <input type="text" class="form-control" id="nombreEnvio" required>
                            </div>
                            <div class="col-md-6">
                                <label for="telefonoEnvio" class="form-label">Teléfono *</label>
                                <input type="tel" class="form-control" id="telefonoEnvio" required>
                            </div>
                            <div class="col-12">
                                <label for="direccionEnvio" class="form-label">Dirección completa *</label>
                                <input type="text" class="form-control" id="direccionEnvio" placeholder="Calle, número, colonia" required>
                            </div>
                            <div class="col-md-6">
                                <label for="ciudadEnvio" class="form-label">Ciudad *</label>
                                <input type="text" class="form-control" id="ciudadEnvio" required>
                            </div>
                            <div class="col-md-6">
                                <label for="cpEnvio" class="form-label">Código Postal *</label>
                                <input type="text" class="form-control" id="cpEnvio" required>
                            </div>
                            <div class="col-12">
                                <label for="notasEnvio" class="form-label">Notas adicionales (opcional)</label>
                                <textarea class="form-control" id="notasEnvio" rows="2" placeholder="Referencias, instrucciones especiales, etc."></textarea>
                            </div>
                        </div>

                        <!-- Resumen del pedido -->
                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="mb-3"><i class="fas fa-receipt me-2"></i>Resumen del Pedido</h6>
                            <div id="resumen-productos"></div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total a pagar:</strong>
                                <strong class="text-success" id="total-checkout">$0.00</strong>
                            </div>
                        </div>
                    </form>
                </div>
            
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" form="checkoutForm" class="btn btn-success" id="btnConfirmarPedido">
                        <i class="fas fa-check-circle me-2"></i>Confirmar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!--Footer-->
    <footer class="text-center text-white py-3" style="background-color: #122C4F;">
        <p>&copy; 2025 Gadget Go- Todos los derechos reservados</p>
    </footer>
    <!-- REEMPLAZA TODO EL <script> al final del body por este -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // ✅ TU CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBg9o3wVZoA26Aob2RnbVPV8vGv4GE44gs",
            authDomain: "primer-proyecto-7b2f4.firebaseapp.com",
            projectId: "primer-proyecto-7b2f4",
            storageBucket: "primer-proyecto-7b2f4.firebasestorage.app",
            messagingSenderId: "627220736817",
            appId: "1:627220736817:web:a2eb4f187322c609f11e10"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // FUNCIÓN PARA CARGAR EL PRODUCTO
        async function cargarProducto() {
            // OBTENER ID DEL HASH (#) en lugar de query params (?)
            const hash = window.location.hash;
            const id = hash ? hash.substring(1) : null; // Quitar el #

            console.log("URL completa:", window.location.href);
            console.log("Hash:", hash);
            console.log("ID extraído:", id);

            const cont = document.getElementById("producto-container");

            if (!id) {
                cont.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>No se especificó un producto</h4>
                        <p>URL: ${window.location.href}</p>
                        <p>Hash: ${hash}</p>
                    </div>
                `;
                return;
            }

            try {
                // Obtener producto de Firestore
                const docRef = doc(db, "productos", id);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    cont.innerHTML = `<p class="text-center text-danger">Producto no encontrado</p>`;
                    return;
                }

                const prod = { id: docSnap.id, ...docSnap.data() };

                // Manejo de imágenes
                let imgSrc = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCBmaWxsPSIjZTVlN2ViIiB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIvPjx0ZXh0IGZpbGw9IiM5Y2EzYWYiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjI0IiB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+U2luIEltYWdlbjwvdGV4dD48L3N2Zz4=';

                if (Array.isArray(prod.imagenes) && prod.imagenes.length > 0) {
                    const primeraImagen = prod.imagenes[0];
                    
                    if (typeof primeraImagen === 'string' && primeraImagen.trim() !== '') {
                        imgSrc = primeraImagen;
                    } else if (typeof primeraImagen === 'object' && primeraImagen.dataURL) {
                        imgSrc = primeraImagen.dataURL;
                    }
                }

                // Renderizar producto
                cont.innerHTML = `
                    <div class="card shadow p-5 ">
                        <div class="row">
                            <div class="col-md-6 text-center">
                                <img src="${imgSrc}" class="img-fluid rounded" alt="${prod.nombre}" style="max-height: 500px; object-fit: cover;">
                            </div>
                            <div class="col-md-6 py-2">
                                <h2>${prod.nombre}</h2>
                                <h4 class="text-success mb-3" style="font-size: 2rem;"><strong>$${Number(prod.precio).toLocaleString('es-MX', { minimumFractionDigits: 2 })}</strong></h4>
                                
                                <div class="mb-3">
                                    <p class="mb-1"><strong>Modelo:</strong> ${prod.modelo || 'N/A'}</p>
                                    <p class="mb-1"><strong>Categoría:</strong> ${prod.categoria || 'N/A'}</p>
                                    <p class="mb-1"><strong>Estado:</strong> <span class="badge bg-info">${prod.estado || 'N/A'}</span></p>
                                    <p class="mb-1"> ${prod.stock || '0'} unidades</p>
                                </div>

                                <h5>Caracteristicas:</h5>
                                <p>${prod.descripcion || "Sin descripción"}</p>
                                
                                <button class="btn btn-primary w-100 mt-3" id="btnAgregar">
                                    <i class="fas fa-cart-plus me-2"></i>Agregar al carrito
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Event listener para agregar al carrito
                document.getElementById('btnAgregar').addEventListener('click', () => {
                    agregarAlCarrito({
                        id: prod.id,
                        nombre: prod.nombre,
                        precio: prod.precio,
                        cantidad: 1,
                        imagen: imgSrc
                    });
                });

            } catch (error) {
                console.error("Error cargando producto:", error);
                cont.innerHTML = `<p class="text-center text-danger">Error al cargar el producto: ${error.message}</p>`;
            }
        }
        // Cargar producto al cargar la página
        cargarProducto();

        /* Botón volver
        document.getElementById('back-button').addEventListener('click', () => {
            window.history.back();
        });
        */

        // ACTUALIZAR CARRITO
        window.actualizarCarrito = function() {
            const contenedor = document.getElementById('carrito-container');
            const contador = document.getElementById('contador-carrito');
            const totalElement = document.getElementById('total-carrito');
            const btnProceder = document.getElementById('btnProcederPago');
            
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            
            contador.textContent = carrito.reduce((acc, p) => acc + p.cantidad, 0);

            if (carrito.length === 0) {
                contenedor.innerHTML = '<p class="text-center text-muted py-4">Tu carrito está vacío</p>';
                if (totalElement) totalElement.textContent = '$0.00';
                if (btnProceder) btnProceder.disabled = true;
                return;
            }

            if (btnProceder) btnProceder.disabled = false;

            const total = carrito.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);
            if (totalElement) {
                totalElement.textContent = '$' + total.toLocaleString('es-MX', { minimumFractionDigits: 2 });
            }

            contenedor.innerHTML = carrito.map(p => `
                <div class="producto border rounded p-3 my-2 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center flex-grow-1">
                        <img src="${p.imagen}" width="80" height="80" class="me-3 rounded" style="object-fit: cover; cursor: pointer;" onclick="window.location.href='producto.html#${p.id}'">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${p.nombre}</h6>
                            <p class="mb-0 text-muted">$${Number(p.precio).toLocaleString('es-MX', {minimumFractionDigits: 2})} x ${p.cantidad} Pieza(s)</p>
                            <p class="mb-0 fw-bold text-success">Subtotal: $${(p.precio * p.cantidad).toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="eliminarDelCarrito('${p.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // ABRIR CHECKOUT
        window.abrirCheckout = function() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            
            if (carrito.length === 0) {
                showToast('El carrito está vacío', 'warning');
                return;
            }

            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail) {
                showToast('Debes iniciar sesión para realizar una compra', 'warning');
                const carritoModal = bootstrap.Modal.getInstance(document.getElementById('carritoModal'));
                if (carritoModal) carritoModal.hide();
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
                return;
            }

            const resumen = document.getElementById('resumen-productos');
            const total = carrito.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);
            
            resumen.innerHTML = carrito.map(p => `
                <div class="d-flex justify-content-between mb-2">
                    <span>${p.nombre} x${p.cantidad}</span>
                    <span>$${(p.precio * p.cantidad).toLocaleString('es-MX', {minimumFractionDigits: 2})}</span>
                </div>
            `).join('');
            
            document.getElementById('total-checkout').textContent = '$' + total.toLocaleString('es-MX', {minimumFractionDigits: 2});

            const carritoModal = bootstrap.Modal.getInstance(document.getElementById('carritoModal'));
            if (carritoModal) carritoModal.hide();
            
            const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
            checkoutModal.show();
        }

              // CONFIRMAR PEDIDO
        function inicializarCheckout() {
            const checkoutForm = document.getElementById('checkoutForm');
            
            if (!checkoutForm) {
                console.warn('Formulario checkoutForm no encontrado aún');
                return;
            }
            
            checkoutForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const btnConfirmar = document.getElementById('btnConfirmarPedido');
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';

                const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
                const userId = localStorage.getItem('userId');
                const userEmail = localStorage.getItem('userEmail');

                if (!userId || carrito.length === 0) {
                    showToast('Error: no hay usuario o carrito vacío', 'danger');
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check-circle me-2"></i>Confirmar Pedido';
                    return;
                }

                const total = carrito.reduce((sum, p) => sum + (p.precio * p.cantidad), 0);

                const pedido = {
                    userId: userId,
                    userEmail: userEmail,
                    productos: carrito,
                    total: total,
                    estado: 'pendiente',
                    datosEnvio: {
                        nombre: document.getElementById('nombreEnvio').value,
                        telefono: document.getElementById('telefonoEnvio').value,
                        direccion: document.getElementById('direccionEnvio').value,
                        ciudad: document.getElementById('ciudadEnvio').value,
                        codigoPostal: document.getElementById('cpEnvio').value,
                        notas: document.getElementById('notasEnvio').value
                    },
                    fecha: serverTimestamp()
                };

                try {
                    const docRef = await addDoc(collection(db, 'pedidos'), pedido);
                    console.log('✅ Pedido creado:', docRef.id);

                    localStorage.removeItem('carrito');
                    actualizarCarrito();

                    const checkoutModal = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));
                    if (checkoutModal) checkoutModal.hide();

                    document.getElementById('checkoutForm').reset();

                    showToast('¡Pedido realizado con éxito!', 'success');

                } catch (error) {
                    console.error('Error creando pedido:', error);
                    showToast('Error al procesar el pedido: ' + error.message, 'danger');
                } finally {
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check-circle me-2"></i>Confirmar Pedido';
                }
            });
            
            console.log('Event listener del checkout agregado correctamente');
        }

    </script>
</body>
</html>
